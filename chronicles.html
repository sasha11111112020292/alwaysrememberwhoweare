<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicles ‚Ä¢ Oleksandr Baiurak</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap');
        
        :root {
            --paper: #fcfaf6;
            --ink: #1a1a1a;
            --sepia: #5c4b37;
            --gold: #b38b6d;
            --border: #e8e0d5;
            --crimson: #9d174d;
            --navy: #0f172a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'EB Garamond', serif;
            background: var(--paper);
            color: var(--ink);
            line-height: 1.7;
            font-weight: 400;
            letter-spacing: 0.3px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(179, 139, 109, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(157, 23, 77, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .paper-texture {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.02"><path d="M0,50 Q25,25 50,50 T100,50" stroke="%235c4b37" fill="none"/></svg>');
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 30px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            padding-bottom: 50px;
            margin-bottom: 40px;
            position: relative;
        }
        
        .header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
        }
        
        .iconic-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 4.5rem;
            font-weight: 400;
            color: var(--ink);
            letter-spacing: 3px;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        
        .iconic-title::after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--gold), var(--crimson));
            transition: width 0.5s ease;
        }
        
        .iconic-title:hover::after {
            width: 100%;
        }
        
        .subtitle {
            font-size: 1.3rem;
            color: var(--sepia);
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 25px;
        }
        
        .epigraph {
            max-width: 700px;
            margin: 30px auto;
            padding: 30px;
            font-style: italic;
            color: var(--sepia);
            border: 1px solid var(--border);
            background: rgba(232, 224, 213, 0.1);
            line-height: 1.8;
            position: relative;
        }
        
        .epigraph::before {
            content: "‚úß";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--paper);
            padding: 0 20px;
            color: var(--gold);
            font-size: 1.2rem;
        }
        
        /* NOTIFICATION SYSTEM */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-content {
            background: var(--ink);
            color: var(--paper);
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid var(--gold);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-family: 'Cormorant Garamond', serif;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--paper);
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: auto;
        }
        
        /* FORM SECTION */
        .form-section {
            background: rgba(232, 224, 213, 0.15);
            padding: 50px 40px;
            border: 2px solid var(--border);
            margin-bottom: 60px;
            position: relative;
            border-radius: 2px;
        }
        
        .form-section::before {
            content: "‚úí";
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 4rem;
            color: rgba(179, 139, 109, 0.1);
        }
        
        .form-title {
            font-size: 1.8rem;
            color: var(--ink);
            margin-bottom: 40px;
            font-weight: 500;
            letter-spacing: 1px;
            font-family: 'Cormorant Garamond', serif;
            position: relative;
            padding-bottom: 15px;
        }
        
        .form-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 2px;
            background: linear-gradient(90deg, var(--gold), transparent);
        }
        
        .form-group {
            margin-bottom: 30px;
        }
        
        .form-label {
            display: block;
            color: var(--sepia);
            margin-bottom: 12px;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .form-input,
        .form-textarea {
            width: 100%;
            padding: 15px 0;
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--border);
            color: var(--ink);
            font-family: 'EB Garamond', serif;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            resize: vertical;
        }
        
        .form-textarea {
            min-height: 150px;
            line-height: 1.8;
        }
        
        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-bottom-color: var(--gold);
        }
        
        .file-upload {
            margin: 40px 0;
        }
        
        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 15px 30px;
            background: transparent;
            border: 2px solid var(--border);
            color: var(--sepia);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-family: 'Cormorant Garamond', serif;
        }
        
        .file-label:hover {
            border-color: var(--gold);
            color: var(--ink);
            background: rgba(179, 139, 109, 0.05);
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 40px 0;
        }
        
        .button {
            background: transparent;
            border: 2px solid var(--ink);
            color: var(--ink);
            padding: 16px 40px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.4s ease;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
            text-decoration: none;
        }
        
        .button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(179, 139, 109, 0.2), transparent);
            transition: 0.6s;
        }
        
        .button:hover::before {
            left: 100%;
        }
        
        .button:hover {
            background: var(--ink);
            color: var(--paper);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(26, 26, 26, 0.1);
        }
        
        .button-primary {
            background: linear-gradient(45deg, var(--crimson), var(--navy));
            color: white;
            border: none;
        }
        
        .button-primary:hover {
            background: linear-gradient(45deg, var(--navy), var(--crimson));
        }
        
        /* EVIDENCE GRID */
        .evidence-grid {
            margin: 60px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--sepia);
            font-style: italic;
            font-size: 1.2rem;
            background: rgba(232, 224, 213, 0.1);
            border: 2px dashed var(--border);
        }
        
        .evidence-card {
            background: var(--paper);
            padding: 40px;
            border: 2px solid var(--border);
            margin-bottom: 30px;
            position: relative;
            transition: all 0.4s ease;
        }
        
        .evidence-card:hover {
            border-color: var(--gold);
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
        }
        
        .evidence-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(var(--gold), var(--crimson));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .evidence-card:hover::before {
            opacity: 1;
        }
        
        .evidence-text {
            font-size: 1.4rem;
            color: var(--ink);
            line-height: 1.9;
            margin-bottom: 30px;
            font-style: italic;
            position: relative;
            padding-left: 30px;
        }
        
        .evidence-text::before {
            content: "‚ùù";
            position: absolute;
            left: 0;
            top: -10px;
            font-size: 3rem;
            color: rgba(179, 139, 109, 0.4);
            font-family: 'Cormorant Garamond', serif;
        }
        
        .evidence-meta {
            font-size: 0.95rem;
            color: var(--sepia);
            border-top: 2px solid var(--border);
            padding-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        
        .evidence-source {
            font-weight: 600;
            color: var(--ink);
        }
        
        .evidence-date {
            margin-left: auto;
            opacity: 0.8;
        }
        
        .tag {
            display: inline-block;
            background: transparent;
            color: var(--sepia);
            padding: 6px 15px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
            margin-right: 10px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .tag:hover {
            background: rgba(179, 139, 109, 0.1);
            border-color: var(--gold);
        }
        
        .media-preview {
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .media-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border: 1px solid var(--border);
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .media-preview img:hover {
            transform: scale(1.05);
        }
        
        /* RANDOM DISPLAY */
        .random-display {
            display: none;
            background: linear-gradient(135deg, rgba(232, 224, 213, 0.2), rgba(179, 139, 109, 0.1));
            padding: 50px;
            border: 2px solid var(--gold);
            margin: 50px 0;
            text-align: center;
            position: relative;
            border-radius: 2px;
        }
        
        .random-display::before {
            content: "üé≤";
            position: absolute;
            top: -25px;
            right: 30px;
            font-size: 3rem;
            background: var(--paper);
            padding: 0 20px;
        }
        
        .random-title {
            font-size: 1.8rem;
            color: var(--sepia);
            margin-bottom: 30px;
            font-family: 'Cormorant Garamond', serif;
        }
        
        /* FOOTER */
        .footer {
            text-align: center;
            margin-top: 100px;
            padding-top: 60px;
            border-top: 2px solid var(--border);
            color: var(--sepia);
        }
        
        .signature {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            margin: 30px 0;
            color: var(--ink);
        }
        
        .back-link {
            text-align: center;
            margin-top: 50px;
            margin-bottom: 30px;
        }
        
        .back-link a {
            color: var(--sepia);
            text-decoration: none;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            border: 1px solid var(--border);
        }
        
        .back-link a:hover {
            color: var(--ink);
            border-color: var(--gold);
            background: rgba(179, 139, 109, 0.05);
        }
        
        /* IMPORT/EXPORT PROGRESS */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border);
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--crimson));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }
            
            .iconic-title {
                font-size: 3rem;
            }
            
            .form-section {
                padding: 30px 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button {
                width: 100%;
                justify-content: center;
            }
            
            .evidence-text {
                font-size: 1.2rem;
                padding-left: 20px;
            }
            
            .evidence-card {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="paper-texture"></div>
    
    <div class="container">
        <header class="header">
            <h1 class="iconic-title">CHRONICLES</h1>
            <div class="subtitle">of Oleksandr Baiurak</div>
            
            <div class="epigraph">
                An archive of evidence, remembrance, and testament. 
                Each entry is proof that some stories must be preserved.
                What must be remembered, shall be recorded. Evidence preserved is history reclaimed.
            </div>
            
            <div style="display: flex; justify-content: center; gap: 40px; 
                        font-size: 0.9rem; color: var(--sepia); 
                        text-transform: uppercase; letter-spacing: 0.5px; margin-top: 30px;">
                <div>Volume I</div>
                <div>‚Ä¢</div>
                <div>Born Stonewall 1969</div>
                <div>‚Ä¢</div>
                <div>Still fighting 2026</div>
            </div>
        </header>

        <section class="form-section">
            <h2 class="form-title">Archive Your Evidence</h2>
            
            <div class="form-group">
                <label class="form-label">The Evidence</label>
                <textarea class="form-textarea" id="evidenceText" 
                          placeholder="What happened? What was said? What must be remembered?..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Source / Context</label>
                <input type="text" class="form-input" id="evidenceSource" 
                       placeholder="Who? Where? When? (e.g., 'Medical records, 2025', 'Teacher conversation, Monday 9am')">
            </div>
            
            <div class="form-group">
                <label class="form-label">Tags (separate with spaces)</label>
                <input type="text" class="form-input" id="evidenceTags" 
                       placeholder="#medical #conversation #evidence #strength">
            </div>
            
            <div class="file-upload">
                <label class="file-label" for="fileInput">
                    üìé Attach Evidence Files (images, screenshots, videos)
                </label>
                <input type="file" id="fileInput" accept="image/*,video/*,application/pdf" multiple style="display: none;">
                <div id="filePreview" class="media-preview" style="margin-top: 20px;"></div>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="button-group">
                <button class="button button-primary" id="saveEvidence">
                    <span>üìù</span>
                    Archive This Entry
                </button>
                
                <button class="button" id="randomBtn">
                    <span>‚ú®</span>
                    Random Memory
                </button>
                
                <a href="index.html" class="button">
                    <span>‚Üê</span>
                    Back to Main
                </a>
            </div>
            
            <div style="margin-top: 50px; padding-top: 30px; border-top: 2px solid var(--border);">
                <div style="font-size: 1.1rem; color: var(--sepia); margin-bottom: 25px; font-family: 'Cormorant Garamond';">
                    üì¶ Archive Management
                </div>
                <div class="button-group">
                    <button class="button" id="exportArchiveBtn">
                        <span>üì§</span>
                        Export Archive
                    </button>
                    <button class="button" id="importArchiveBtn">
                        <span>üì•</span>
                        Import Archive
                    </button>
                    <button class="button" id="clearArchiveBtn" style="border-color: var(--crimson); color: var(--crimson);">
                        <span>üóëÔ∏è</span>
                        Clear Archive
                    </button>
                </div>
                <div style="margin-top: 20px; font-size: 0.9rem; color: var(--sepia); line-height: 1.6;">
                    üí° <strong>Sync across devices:</strong> Export ‚Üí Save to <a href="https://drive.google.com/drive/folders/1kcHmkUSNuirFBFuSKRZ4GiEH9z54f2iN" target="_blank" style="color: var(--crimson);">Google Drive</a> ‚Üí Import on other device
                </div>
            </div>
        </section>

        <div class="random-display" id="randomDisplay">
            <!-- Random entry will appear here -->
        </div>

        <section class="evidence-grid" id="evidenceGrid">
            <div class="empty-state" id="emptyState">
                The Chronicles await their first entry.<br>
                Add your evidence above to begin the archive.
            </div>
        </section>

        <div class="back-link">
            <a href="index.html">
                <span>‚Üê</span>
                Return to Main Story: Future Human Rights Advocate
            </a>
        </div>

        <div class="footer">
            <div class="signature">ùí™ùìÅùìÆùìÄùìàùí∂ùìÉùíπùìá ùêµùí∂ùíæùìäùìáùí∂ùìÄ</div>
            <div style="font-size: 1rem; letter-spacing: 0.5px; margin-top: 15px; color: var(--sepia);">
                "C'est vraiment possible!" ‚Ä¢ Paris ‚ú® ‚Ä¢ Human Rights üïäÔ∏è ‚Ä¢ Love üíï
            </div>
            <div style="font-size: 0.9rem; margin-top: 30px; color: rgba(92, 75, 55, 0.6);">
                Chronicles preserved across time and space ‚Ä¢ 2026
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>

    <script>
        // ============================================
        // DATABASE & STATE MANAGEMENT
        // ============================================
        const DB_NAME = 'ChroniclesArchiveDB';
        const DB_VERSION = 2;
        const STORE_NAME = 'evidenceEntries';
        const DRIVE_FOLDER_ID = '1kcHmkUSNuirFBFuSKRZ4GiEH9z54f2iN';
        
        let db = null;
        let evidenceEntries = [];
        
        // Initialize database
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error('Database error:', request.error);
                    loadFromLocalStorage();
                    resolve(false);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database initialized');
                    loadAllEvidence();
                    resolve(true);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Delete old object stores if they exist
                    if (db.objectStoreNames.contains('evidence')) {
                        db.deleteObjectStore('evidence');
                    }
                    
                    // Create new object store
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('tags', 'tags', { unique: false, multiEntry: true });
                    }
                };
            });
        }
        
        // Load all evidence from database
        async function loadAllEvidence() {
            if (!db) {
                loadFromLocalStorage();
                return;
            }
            
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const index = store.index('timestamp');
                const request = index.getAll();
                
                request.onsuccess = () => {
                    evidenceEntries = request.result || [];
                    evidenceEntries.sort((a, b) => b.timestamp - a.timestamp); // Newest first
                    renderEvidence();
                    resolve();
                };
                
                request.onerror = () => {
                    console.error('Error loading evidence');
                    loadFromLocalStorage();
                    resolve();
                };
            });
        }
        
        // Fallback to localStorage
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('chronicles_archive_v2');
            if (saved) {
                try {
                    evidenceEntries = JSON.parse(saved);
                    renderEvidence();
                } catch (e) {
                    console.error('Error parsing localStorage data:', e);
                    evidenceEntries = [];
                }
            }
        }
        
        // Save to localStorage as backup
        function backupToLocalStorage() {
            localStorage.setItem('chronicles_archive_v2', JSON.stringify(evidenceEntries));
        }
        
        // Save evidence entry
        async function saveEvidenceEntry(entry) {
            if (!db) {
                // Save to localStorage only
                evidenceEntries.unshift(entry);
                backupToLocalStorage();
                renderEvidence();
                return entry;
            }
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                // Generate a unique ID
                entry.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const request = store.add(entry);
                
                request.onsuccess = () => {
                    evidenceEntries.unshift(entry);
                    backupToLocalStorage(); // Backup to localStorage
                    renderEvidence();
                    resolve(entry);
                };
                
                request.onerror = (event) => {
                    console.error('Error saving to DB:', request.error);
                    // Fallback to localStorage
                    evidenceEntries.unshift(entry);
                    backupToLocalStorage();
                    renderEvidence();
                    resolve(entry);
                };
            });
        }
        
        // Clear all evidence
        async function clearAllEvidence() {
            if (confirm("‚ö†Ô∏è Are you absolutely sure? This will delete ALL entries permanently. This cannot be undone.")) {
                if (confirm("‚ö†Ô∏è LAST WARNING: Delete ALL chronicles?")) {
                    if (db) {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        store.clear();
                    }
                    
                    evidenceEntries = [];
                    localStorage.removeItem('chronicles_archive_v2');
                    
                    renderEvidence();
                    showNotification('üóëÔ∏è Archive cleared', 'All entries have been deleted.');
                }
            }
        }
        
        // ============================================
        // UI RENDERING
        // ============================================
        function renderEvidence() {
            const grid = document.getElementById('evidenceGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (evidenceEntries.length === 0) {
                emptyState.style.display = 'block';
                grid.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let html = '';
            evidenceEntries.forEach((entry, index) => {
                let mediaHTML = '';
                if (entry.media && entry.media.length > 0) {
                    mediaHTML = '<div class="media-preview">';
                    entry.media.forEach(media => {
                        if (media.type.startsWith('image/')) {
                            mediaHTML += `<img src="${media.data}" alt="${media.name}" onclick="openMedia('${media.data}')">`;
                        } else if (media.type.startsWith('video/')) {
                            mediaHTML += `
                                <div style="position: relative;">
                                    <video src="${media.data}" style="width: 100%; height: 150px; object-fit: cover; border: 1px solid var(--border);"></video>
                                    <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; padding: 2px 8px; font-size: 0.8rem; border-radius: 3px;">VIDEO</div>
                                </div>`;
                        } else if (media.type === 'application/pdf') {
                            mediaHTML += `
                                <div style="padding: 20px; border: 1px solid var(--border); background: rgba(232, 224, 213, 0.3); display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.5rem;">üìÑ</span>
                                    <div>
                                        <div style="font-weight: bold;">PDF</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">${media.name}</div>
                                    </div>
                                </div>`;
                        }
                    });
                    mediaHTML += '</div>';
                }
                
                // Parse tags
                let tags = entry.tags || '#evidence';
                if (typeof tags === 'string') {
                    tags = tags.split(' ').filter(tag => tag.trim());
                }
                
                html += `
                    <div class="evidence-card" data-index="${index}">
                        <div class="evidence-text">${entry.text}</div>
                        ${mediaHTML}
                        <div class="evidence-meta">
                            <div style="flex: 1;">
                                <div class="evidence-source">${entry.source || 'Anonymous'}</div>
                                <div style="margin-top: 10px;">
                                    ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                            </div>
                            <div class="evidence-date">${entry.date || formatDate(entry.timestamp)}</div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            
            // Remove existing notifications
            container.innerHTML = '';
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                drive: '‚òÅÔ∏è'
            };
            
            const icon = icons[type] || icons.info;
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-header">
                        <span style="font-size: 1.5rem;">${icon}</span>
                        <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        <button class="notification-close" onclick="this.closest('.notification').remove()">√ó</button>
                    </div>
                    <div style="line-height: 1.6;">${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds (except drive notifications)
            if (type !== 'drive') {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
        }
        
        // ============================================
        // EVENT HANDLERS
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize database
            await initDB();
            
            // Show welcome notification
            setTimeout(() => {
                showNotification(`
                    <strong>Welcome to the Chronicles Archive</strong><br><br>
                    üíæ <strong>Sync across devices:</strong><br>
                    1. Click <strong>üì§ Export Archive</strong> on this device<br>
                    2. Save the .json file to <a href="https://drive.google.com/drive/folders/${DRIVE_FOLDER_ID}" target="_blank" style="color: #b38b6d; text-decoration: underline;">Google Drive</a><br>
                    3. On another device: Click <strong>üì• Import Archive</strong><br><br>
                    Your evidence will be preserved everywhere.
                `, 'drive');
            }, 1000);
            
            // File preview handler
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const preview = document.getElementById('filePreview');
                preview.innerHTML = '';
                
                Array.from(e.target.files).forEach(file => {
                    if (file.size > 15 * 1024 * 1024) {
                        showNotification(`File "${file.name}" is too large (max 15MB)`, 'warning');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const div = document.createElement('div');
                        div.style.cssText = 'position: relative;';
                        
                        if (file.type.startsWith('image/')) {
                            div.innerHTML = `
                                <img src="${e.target.result}" alt="${file.name}" 
                                     style="width: 100%; height: 150px; object-fit: cover; border: 1px solid var(--border);">
                                <div style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; font-size: 0.7rem; border-radius: 3px;">
                                    ${file.name}
                                </div>
                            `;
                        } else if (file.type.startsWith('video/')) {
                            div.innerHTML = `
                                <video src="${e.target.result}" 
                                       style="width: 100%; height: 150px; object-fit: cover; border: 1px solid var(--border);"></video>
                                <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; font-size: 0.7rem; border-radius: 3px;">
                                    VIDEO
                                </div>
                            `;
                        } else {
                            div.innerHTML = `
                                <div style="padding: 20px; border: 1px solid var(--border); background: rgba(232, 224, 213, 0.5); text-align: center;">
                                    <div style="font-size: 2rem;">üìÑ</div>
                                    <div style="font-size: 0.8rem; margin-top: 10px; word-break: break-all;">${file.name}</div>
                                </div>
                            `;
                        }
                        
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            });
            
            // Save evidence handler
            document.getElementById('saveEvidence').addEventListener('click', async () => {
                const text = document.getElementById('evidenceText').value.trim();
                const source = document.getElementById('evidenceSource').value.trim();
                const tags = document.getElementById('evidenceTags').value.trim();
                
                if (!text) {
                    showNotification('Please provide evidence text.', 'warning');
                    return;
                }
                
                // Show progress
                const progressBar = document.getElementById('progressBar');
                const progressFill = document.getElementById('progressFill');
                progressBar.style.display = 'block';
                progressFill.style.width = '30%';
                
                const fileInput = document.getElementById('fileInput');
                const media = [];
                
                if (fileInput.files.length > 0) {
                    for (const file of fileInput.files) {
                        if (file.size > 15 * 1024 * 1024) {
                            showNotification(`File "${file.name}" is too large (max 15MB)`, 'warning');
                            continue;
                        }
                        
                        progressFill.style.width = '50%';
                        
                        const dataURL = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        
                        media.push({
                            name: file.name,
                            type: file.type,
                            data: dataURL,
                            size: file.size
                        });
                    }
                }
                
                progressFill.style.width = '80%';
                
                const newEntry = {
                    text: text,
                    source: source || 'Anonymous',
                    tags: tags || '#evidence',
                    date: new Date().toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    timestamp: Date.now(),
                    media: media
                };
                
                try {
                    await saveEvidenceEntry(newEntry);
                    
                    // Clear form
                    document.getElementById('evidenceText').value = '';
                    document.getElementById('evidenceSource').value = '';
                    document.getElementById('evidenceTags').value = '';
                    document.getElementById('fileInput').value = '';
                    document.getElementById('filePreview').innerHTML = '';
                    
                    // Show success
                    progressFill.style.width = '100%';
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        progressFill.style.width = '0%';
                    }, 500);
                    
                    showNotification('‚úÖ Entry archived successfully!', 'success');
                    
                    // Scroll to new entry
                    document.querySelector('.evidence-card')?.scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Save error:', error);
                    showNotification('Error saving evidence.', 'error');
                    progressBar.style.display = 'none';
                }
            });
            
            // Random entry handler
            document.getElementById('randomBtn').addEventListener('click', () => {
                if (evidenceEntries.length === 0) {
                    showNotification('No entries yet. Add some evidence first!', 'info');
                    return;
                }
                
                const randomEntry = evidenceEntries[Math.floor(Math.random() * evidenceEntries.length)];
                const display = document.getElementById('randomDisplay');
                
                let mediaHTML = '';
                if (randomEntry.media && randomEntry.media.length > 0) {
                    const media = randomEntry.media[0];
                    if (media.type.startsWith('image/')) {
                        mediaHTML = `<img src="${media.data}" style="max-width: 300px; margin: 20px auto; border: 1px solid var(--border); display: block;" onclick="openMedia('${media.data}')">`;
                    }
                }
                
                // Parse tags
                let tags = randomEntry.tags || '#evidence';
                if (typeof tags === 'string') {
                    tags = tags.split(' ').filter(tag => tag.trim());
                }
                
                display.innerHTML = `
                    <div class="random-title">Random Memory</div>
                    <div style="font-size: 1.5rem; line-height: 1.9; font-style: italic; margin-bottom: 30px; color: var(--ink);">
                        "${randomEntry.text}"
                    </div>
                    ${mediaHTML}
                    <div style="color: var(--sepia); margin: 20px 0;">
                        <div style="margin-bottom: 10px;"><strong>Source:</strong> ${randomEntry.source}</div>
                        <div style="margin: 15px 0;">
                            ${tags.map(tag => `<span class="tag" style="margin: 5px;">${tag}</span>`).join('')}
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 20px;">
                            ${randomEntry.date || formatDate(randomEntry.timestamp)}
                        </div>
                    </div>
                    <button onclick="document.getElementById('randomDisplay').style.display='none'" 
                            style="margin-top: 30px; background: transparent; border: 1px solid var(--border); color: var(--sepia); padding: 10px 25px; cursor: pointer; font-family: 'Cormorant Garamond';">
                        Close
                    </button>
                `;
                display.style.display = 'block';
                display.scrollIntoView({ behavior: 'smooth' });
            });
            
            // Export archive handler
            document.getElementById('exportArchiveBtn').addEventListener('click', async () => {
                try {
                    showNotification('üîÑ Preparing export...', 'info');
                    
                    // Load fresh data
                    await loadAllEvidence();
                    
                    const exportData = {
                        version: 3,
                        type: 'chronicles_archive',
                        timestamp: new Date().toISOString(),
                        exportDate: new Date().toLocaleString(),
                        device: navigator.platform,
                        entries: evidenceEntries,
                        stats: {
                            totalEntries: evidenceEntries.length,
                            totalSize: JSON.stringify(evidenceEntries).length,
                            tags: Array.from(new Set(evidenceEntries.flatMap(e => 
                                typeof e.tags === 'string' ? e.tags.split(' ').filter(t => t.trim()) : e.tags || []
                            )))
                        }
                    };
                    
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chronicles-archive-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification(`
                        ‚úÖ <strong>Archive exported!</strong><br><br>
                        <strong>Save this file to:</strong><br>
                        <a href="https://drive.google.com/drive/folders/${DRIVE_FOLDER_ID}" target="_blank" style="color: #b38b6d; text-decoration: underline;">
                            Your Google Drive Folder
                        </a><br><br>
                        Total entries: ${evidenceEntries.length}<br>
                        File ready for sync across devices.
                    `, 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    showNotification('‚ùå Export failed: ' + error.message, 'error');
                }
            });
            
            // Import archive handler - FIXED VERSION
            document.getElementById('importArchiveBtn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,application/json';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        showNotification('üîÑ Reading archive file...', 'info');
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        let entriesToImport = [];
                        
                        // ===== SUPPORT MULTIPLE FORMATS =====
                        
                        // 1. Chronicles format (version 3)
                        if (data.type === 'chronicles_archive' && data.entries && Array.isArray(data.entries)) {
                            entriesToImport = data.entries;
                        }
                        // 2. Main page export format (version 2)
                        else if (data.version === 2 && (data.thoughts || data.songs)) {
                            showNotification('üì• Converting main page export...', 'info');
                            
                            // Convert thoughts
                            if (data.thoughts && data.thoughts.trim()) {
                                entriesToImport.push({
                                    text: data.thoughts,
                                    source: "Main Page Export",
                                    tags: "#thoughts #export #mainpage",
                                    date: data.exportDate || new Date().toLocaleDateString(),
                                    timestamp: data.timestamp ? new Date(data.timestamp).getTime() : Date.now()
                                });
                            }
                            
                            // Convert songs
                            if (data.songs && data.songs.length > 0) {
                                entriesToImport.push({
                                    text: `Imported ${data.songs.length} audio files from main page. These songs are part of my soundtrack.`,
                                    source: "Main Page Soundtrack",
                                    tags: "#music #anthems #soundtrack",
                                    date: data.exportDate || new Date().toLocaleDateString(),
                                    timestamp: data.timestamp ? new Date(data.timestamp).getTime() : Date.now()
                                });
                            }
                        }
                        // 3. Old Chronicles format (version 1)
                        else if (data.version === 1 && data.entries && Array.isArray(data.entries)) {
                            entriesToImport = data.entries;
                        }
                        // 4. Raw entries array
                        else if (Array.isArray(data)) {
                            entriesToImport = data;
                        }
                        // 5. Single entry
                        else if (data.text) {
                            entriesToImport = [data];
                        }
                        else {
                            throw new Error('This file format is not supported. Please import a valid Chronicles export.');
                        }
                        
                        if (entriesToImport.length === 0) {
                            throw new Error('No valid entries found in the file.');
                        }
                        
                        const confirmed = await new Promise((resolve) => {
                            const modal = document.createElement('div');
                            modal.style.cssText = `
                                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                background: rgba(0,0,0,0.7); z-index: 99999; display: flex; 
                                align-items: center; justify-content: center;
                            `;
                            
                            modal.innerHTML = `
                                <div style="background: var(--paper); padding: 40px; border: 2px solid var(--gold); 
                                            max-width: 500px; width: 90%; color: var(--ink);">
                                    <h2 style="font-family: 'Cormorant Garamond'; margin-bottom: 20px;">Import Archive</h2>
                                    <p style="margin-bottom: 25px; line-height: 1.6;">
                                        Found <strong>${entriesToImport.length}</strong> entries in the archive.<br><br>
                                        How would you like to import them?
                                    </p>
                                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                                        <button id="importMerge" style="flex: 1; padding: 15px; background: var(--ink); color: white; border: none; cursor: pointer; font-family: 'Cormorant Garamond';">
                                            üîÑ Merge (Add to existing)
                                        </button>
                                        <button id="importReplace" style="flex: 1; padding: 15px; background: var(--crimson); color: white; border: none; cursor: pointer; font-family: 'Cormorant Garamond';">
                                            üîÅ Replace (Clear then import)
                                        </button>
                                        <button id="importCancel" style="padding: 15px 25px; background: transparent; border: 1px solid var(--border); color: var(--sepia); cursor: pointer;">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            `;
                            
                            document.body.appendChild(modal);
                            
                            document.getElementById('importMerge').onclick = () => {
                                modal.remove();
                                resolve('merge');
                            };
                            document.getElementById('importReplace').onclick = () => {
                                modal.remove();
                                resolve('replace');
                            };
                            document.getElementById('importCancel').onclick = () => {
                                modal.remove();
                                resolve('cancel');
                            };
                        });
                        
                        if (confirmed === 'cancel') {
                            showNotification('Import cancelled.', 'info');
                            return;
                        }
                        
                        // Show progress
                        showNotification(`üîÑ Importing ${entriesToImport.length} entries...`, 'info');
                        
                        if (confirmed === 'replace') {
                            // Clear existing data
                            if (db) {
                                const transaction = db.transaction([STORE_NAME], 'readwrite');
                                const store = transaction.objectStore(STORE_NAME);
                                store.clear();
                            }
                            evidenceEntries = [];
                            localStorage.removeItem('chronicles_archive_v2');
                        }
                        
                        // Import entries
                        let importedCount = 0;
                        let skippedCount = 0;
                        
                        for (const entry of entriesToImport) {
                            try {
                                // Validate and clean entry
                                if (!entry.text || typeof entry.text !== 'string') {
                                    skippedCount++;
                                    continue;
                                }
                                
                                const cleanEntry = {
                                    text: entry.text,
                                    source: entry.source || entry.from || 'Imported Entry',
                                    tags: entry.tags || '#imported',
                                    date: entry.date || entry.exportDate || formatDate(Date.now()),
                                    timestamp: entry.timestamp || Date.now() - Math.random() * 1000000, // Spread timestamps
                                    media: entry.media || entry.files || []
                                };
                                
                                await saveEvidenceEntry(cleanEntry);
                                importedCount++;
                                
                            } catch (entryError) {
                                console.warn('Failed to import entry:', entryError);
                                skippedCount++;
                            }
                        }
                        
                        // Show result
                        let message = `‚úÖ Successfully imported ${importedCount} entries!`;
                        if (skippedCount > 0) {
                            message += ` (${skippedCount} skipped)`;
                        }
                        
                        showNotification(message, 'success');
                        
                        // Render updated list
                        renderEvidence();
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showNotification(`‚ùå Import failed: ${error.message}`, 'error');
                    }
                };
                
                input.click();
            });
            
            // Clear archive handler
            document.getElementById('clearArchiveBtn').addEventListener('click', clearAllEvidence);
        });
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function openMedia(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 100000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 90vw; max-height: 90vh;">
                    <img src="${url}" style="max-width: 100%; max-height: 90vh;">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); 
                                   color: white; border: none; width: 40px; height: 40px; border-radius: 50%; 
                                   font-size: 1.5rem; cursor: pointer;">
                        √ó
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Expose openMedia globally for onclick handlers
        window.openMedia = openMedia;
    </script>
</body>
</html>